<!DOCTYPE html>
<html>
<head>
    <title>Inspiration Corkboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #ffd1dc;
            font-family: 'Nunito', 'Comic Sans MS', cursive, sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            cursor: default;
        }
        
        /* Board selection screen */
        #board-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffd1dc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        #board-selection h2 {
            color: #d44d8c;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.2rem;
            text-shadow: 2px 2px 0px #fff;
        }
        
        .boards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin-bottom: 30px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(134, 80, 108, 0.2);
        }
        
        .board-item {
            background: linear-gradient(135deg, #d9a8e3 0%, #f8c5e0 100%);
            padding: 20px;
            border-radius: 15px;
            width: 160px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: #7a3c6c;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .board-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .board-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 15px;
            border: none;
            background: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .board-actions button:hover {
            background: white;
            transform: scale(1.1);
        }
        
        #create-board {
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            cursor: pointer;
            font-size: 18px;
            margin-top: 20px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        #create-board:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 156, 0.6);
        }
        
        #create-board-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 25px;
            margin-top: 20px;
            align-items: center;
        }
        
        #new-board-name {
            padding: 12px 15px;
            border: 2px solid #ff9ec9;
            border-radius: 20px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            width: 280px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* Corkboard styling */
        .corkboard-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .corkboard-frame {
            width: 100vw;
            height: 5000px;
            border: 15px solid #b07c57;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.4),
                0 10px 25px rgba(0, 0, 0, 0.4);
            background-image: 
                radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(135deg, #a5724b 0%, #b07c57 100%);
            background-size: 20px 20px, 100% 100%;
            position: relative;
            margin: 0 auto;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 230, 240, 0.95);
            padding: 25px;
            border-radius: 20px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            color: #d44d8c;
            font-weight: bold;
        }
        
        #upload-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 230, 240, 0.9);
            padding: 18px;
            border-radius: 50px;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 100;
            border: 2px solid #ffc2e2;
        }
        
        #text-note { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Comic Sans MS', cursive; width: 200px; }
        
        button {
            padding: 10px 18px;
            background: #ff9ec9;
            border: none;
            border-radius: 25px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 158, 201, 0.4);
        }
        
        button:hover {
            background: #ff85c0;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 158, 201, 0.6);
        }
        
        #corkboard {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: visible;
            z-index: 1;
        }
        
        .note-container {
            position: absolute;
            z-index: 10;
            filter: drop-shadow(4px 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .note { position: relative; min-width: 80px; min-height: 80px; padding: 15px; box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; align-items: center; transition: box-shadow 0.3s; overflow: hidden; }
        
        .note.mine {
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.25);
        }
        
        .note-container:hover {
            z-index: 20;
        }
        
        .pin { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); width: 24px; height: 24px; background-image: url('Images/thumbtack.png'); background-size: contain; background-repeat: no-repeat; cursor: move; z-index: 25; }
        
        .note-text { width: 100%; min-height: 50px; background: transparent; border: none; resize: none; font-family: 'Comic Sans MS', cursive; font-size: 16px; outline: none; flex-grow: 1; margin-top: 5px; padding: 5px; overflow-wrap: break-word; cursor: text; overflow: auto; } .note img { max-width: 100%; max-height: 200px; margin-top: 5px; object-fit: contain; }
        
        .pinned-image {
            box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            background: transparent;
        }
        
        .pinned-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(to right, #ff6b6b, #ff4f4f);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 30;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: rgba(255, 158, 201, 0.7);
            border-radius: 50%;
            right: 4px;
            bottom: 4px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 25;
        }
        
        .note-container:hover .delete-btn,
        .note-container:hover .resize-handle {
            opacity: 1;
        }
        
        /* Sticky note colors */
        .note[data-color="yellow"] { background: linear-gradient(135deg, #fff8b3 0%, #fffacd 100%); }
        .note[data-color="pink"]   { background: linear-gradient(135deg, #ffb3d9 0%, #ffd6eb 100%); }
        .note[data-color="blue"]   { background: linear-gradient(135deg, #b3e0ff 0%, #d6f0ff 100%); }
        .note[data-color="green"]  { background: linear-gradient(135deg, #c6f7d0 0%, #e2ffe9 100%); }
        .note[data-color="purple"] { background: linear-gradient(135deg, #e0b3ff 0%, #f0d9ff 100%); }

        /* Rotation for more natural look */
        .note-container {
            transform: rotate(calc(-3deg + 6deg * random()));
        }
        
        /* Color picker */
        .color-picker {
            display: flex;
            gap: 8px;
            margin-left: 15px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px;
            border-radius: 25px;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.15);
        }
        
        .color-option.active {
            border-color: #7a3c6c;
            transform: scale(1.2);
        }
        
        #yellow { background: #fff8b3; }
        #pink { background: #ffbde1; }
        #blue { background: #b5deff; }
        #green { background: #c5f7cb; }
        #purple { background: #e2c5ff; }
        #lavender { background: #e6e6ff; }
        
        /* Instructions */
        .instructions {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 230, 240, 0.9);
            padding: 15px;
            border-radius: 15px;
            font-size: 14px;
            max-width: 220px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 101;
            border: 2px solid #ffc2e2;
            color: #7a3c6c;
        }
        
        .instructions h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #d44d8c;
        }
        
        .instructions ul {
            margin: 0;
            padding-left: 18px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .toggle-instructions {
            font-size: 18px;
            cursor: pointer;
            color: #ff6b9c;
        }
        
        /* Board header */
        #board-header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 230, 240, 0.9);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 101;
            border: 2px solid #ffc2e2;
        }
        
        #back-to-boards {
            background: #d44d8c;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #rename-board {
            background: #7a3c6c;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 16px;
        }
        
        ::-webkit-scrollbar-track {
            background: #b07c57;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #6e533e;
            border-radius: 8px;
            border: 3px solid #b07c57;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #7e5e46;
        }
    </style>
</head>
<body>
    <div id="board-selection">
        <h2>Select a Corkboard</h2>
        <div class="boards-container" id="boards-list">
            <!-- Boards will be listed here -->
        </div>
        <button id="create-board">Create New Board</button>
        <div id="create-board-form" style="display: none;">
            <input type="text" id="new-board-name" placeholder="Board name">
            <button id="submit-new-board">Create</button>
        </div>
    </div>

    <div class="loading" id="loading">Loading corkboard...</div>

    <div id="board-header" style="display: none;">
        <span id="current-board-name">My Board</span>
        <button id="back-to-boards">Back to Boards</button>
        <button id="rename-board" style="display: none;">Rename Board</button>
    </div>

    <div class="instructions" id="instructions">
        <h3>How to use <span class="toggle-instructions"> +</span></h3>
        <div class="content" style="display: none;">
            <ul>
                <li>Drag notes/images to move (grab by the pin)</li>
                <li>Use resize handle (bottom-right) to resize</li>
                <li>Double-click text to edit</li>
                <li>Click × to delete your notes</li>
                <li>Click on any note to bring it to the front</li>
                <li>Scroll to explore more space on the board</li>
            </ul>
        </div>
    </div>

    <div class="corkboard-container" id="corkboard-container" style="display: none;">
        <div class="corkboard-frame">
            <div id="corkboard">
                <!-- Notes and images will appear here -->
            </div>
        </div>
    </div>

    <div class="corkboard-container" id="corkboard-container" style="display: none;">
        <div class="corkboard-frame">
            <div id="corkboard">
                <!-- Notes and images will appear here -->
            </div>
        </div>
    </div>

    <div id="upload-container" style="display: none;">
        <input type="text" id="text-note" placeholder="Write your note...">
        <div class="color-picker">
            <div class="color-option active" id="yellow" data-color="yellow"></div>
            <div class="color-option" id="pink" data-color="pink"></div>
            <div class="color-option" id="blue" data-color="blue"></div>
            <div class="color-option" id="green" data-color="green"></div>
            <div class="color-option" id="purple" data-color="purple"></div>
        </div>
        <input type="file" id="image-upload" accept="image/*" style="display: none;">
        <button id="add-text">Add Text Note</button>
        <button id="add-image">Add Image</button>
    </div>

    <script>
        // Supabase configuration - replace with your project details
        const SUPABASE_URL = "https://qcjeiiyhipmlhmqgjfqu.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_MoixGwsqhk6fM-OOL-TA5Q_Y0pR_zun";
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // User and notes variables
        let currentUser = null;
        let notes = [];
        let selectedColor = 'yellow';
        let highestZIndex = 10;
        let currentBoardId = null;
        let currentBoardName = "";
        let currentBoardCreator = "";
        let unsubscribeNotes = null;
        let scrollY = 0;

       // DOM elements
        const corkboard = document.getElementById('corkboard');
        const loadingElement = document.getElementById('loading');
        const instructions = document.getElementById('instructions');
        const toggleInstructions = document.querySelector('.toggle-instructions');
        const instructionsContent = document.querySelector('.instructions .content');
        const corkboardContainer = document.getElementById('corkboard-container');
        const boardSelection = document.getElementById('board-selection');
        const boardsList = document.getElementById('boards-list');
        const createBoardBtn = document.getElementById('create-board');
        const createBoardForm = document.getElementById('create-board-form');
        const submitNewBoardBtn = document.getElementById('submit-new-board');
        const newBoardNameInput = document.getElementById('new-board-name');
        const boardHeader = document.getElementById('board-header');
        const currentBoardNameSpan = document.getElementById('current-board-name');
        const backToBoardsBtn = document.getElementById('back-to-boards');
        const renameBoardBtn = document.getElementById('rename-board');
        const uploadContainer = document.getElementById('upload-container');

        // Initialize app
        initApp();

        // Toggle instructions (original functionality)
        toggleInstructions.addEventListener('click', function() {
            if (instructionsContent.style.display === 'none') {
                instructionsContent.style.display = 'block';
                toggleInstructions.textContent = '-';
            } else {
                instructionsContent.style.display = 'none';
                toggleInstructions.textContent = '+';
            }
        });

        // Board selection functionality
        createBoardBtn.addEventListener('click', function() {
            createBoardForm.style.display = 'flex';
            createBoardBtn.style.display = 'none'; // Hide create button after clicking
        });

        submitNewBoardBtn.addEventListener('click', function() {
            const boardName = newBoardNameInput.value.trim();
            if (boardName) {
                createNewBoard(boardName);
            }
        });

        backToBoardsBtn.addEventListener('click', function() {
            showBoardSelection();
        });

        renameBoardBtn.addEventListener('click', function() {
            const newName = prompt("Enter new name for this board:", currentBoardName);
            if (newName && newName.trim() !== "") {
                renameBoard(currentBoardId, newName.trim());
            }
        });

        // Track scroll position (vertical only)
        corkboardContainer.addEventListener('scroll', function() {
            scrollY = this.scrollTop;
        });

       async function initApp() {
            try {
                console.log("Initializing Supabase...");
                
                // Generate a random user ID for anonymous usage
                currentUser = { id: generateUserId() };
                console.log("Generated user ID:", currentUser.id);
                
                // Load boards
                loadBoards();
                
                loadingElement.style.display = 'none';
            } catch (error) {
                console.error("Initialization error:", error);
                console.error("Full error details:", JSON.stringify(error, null, 2));
                loadingElement.textContent = `Error: ${error.message}`;
            }
        }
        
        // Generate a unique user ID for anonymous users
        function generateUserId() {
            // Try to get existing user ID from localStorage
            let userId = localStorage.getItem('corkboard_user_id');
            if (!userId) {
                // Generate a new ID if none exists
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('corkboard_user_id', userId);
            }
            return userId;
        }
        
        async function loadBoards() {
            try {
                const { data, error } = await supabaseClient
                    .from('boards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error("Error loading boards:", error);
                    return;
                }
                
                boardsList.innerHTML = '';
                if (!data || data.length === 0) {
                    boardsList.innerHTML = '<p style="color: white;">No boards yet. Create the first one!</p>';
                    createBoardBtn.style.display = 'block'; // Show create button if no boards
                } else {
                    data.forEach(board => {
                        const boardItem = document.createElement('div');
                        boardItem.className = 'board-item';
                        boardItem.dataset.boardId = board.id;
                        
                        let actionsHtml = `<button class="open-board" data-id="${board.id}">Open</button>`;
                        
                        // Only show delete button for boards created by current user
                        if (board.created_by === currentUser.id) {
                            actionsHtml += `<button class="delete-board" data-id="${board.id}">Delete</button>`;
                        }
                        
                        boardItem.innerHTML = `
                            <h3 class="board-name">${board.name}</h3>
                            <div class="board-actions">
                                ${actionsHtml}
                            </div>
                        `;
                        boardsList.appendChild(boardItem);
                        
                        // Add double-click event for renaming (only for creator)
                        if (board.created_by === currentUser.id) {
                            const boardNameElement = boardItem.querySelector('.board-name');
                            boardNameElement.addEventListener('dblclick', function(e) {
                                e.stopPropagation();
                                const newName = prompt("Enter new name for this board:", board.name);
                                if (newName && newName.trim() !== "") {
                                    renameBoard(board.id, newName.trim());
                                }
                            });
                        }
                    });
                    
                    // Add event listeners
                    document.querySelectorAll('.open-board').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const boardId = this.getAttribute('data-id');
                            openBoard(boardId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-board').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const boardId = this.getAttribute('data-id');
                            if (confirm('Are you sure you want to delete this board?')) {
                                deleteBoard(boardId);
                            }
                        });
                    });
                }
            } catch (error) {
                console.error("Error loading boards:", error);
            }
        }
        
        async function createNewBoard(name) {
            try {
                const { data, error } = await supabaseClient
                    .from('boards')
                    .insert([
                        { 
                            name: name,
                            created_by: currentUser.id
                        }
                    ])
                    .select();
                
                if (error) {
                    console.error("Error creating board: ", error);
                    return;
                }
                
                console.log("Board created with ID: ", data[0].id);
                newBoardNameInput.value = '';
                createBoardForm.style.display = 'none';
                createBoardBtn.style.display = 'block'; // Show create button again
                openBoard(data[0].id);
            } catch (error) {
                console.error("Error creating board: ", error);
            }
        }
        
        async function renameBoard(boardId, newName) {
            try {
                const { error } = await supabaseClient
                    .from('boards')
                    .update({ name: newName })
                    .eq('id', boardId);
                
                if (error) {
                    console.error("Error renaming board: ", error);
                    alert("Error renaming board. Only the board creator can rename it.");
                    return;
                }
                
                console.log("Board renamed successfully");
                currentBoardName = newName;
                currentBoardNameSpan.textContent = newName;
                
                // Update the board name in the selection list too
                loadBoards();
            } catch (error) {
                console.error("Error renaming board: ", error);
                alert("Error renaming board. Only the board creator can rename it.");
            }
        }
        
        async function deleteBoard(boardId) {
            try {
                // First delete all notes in this board
                const { error: notesError } = await supabaseClient
                    .from('notes')
                    .delete()
                    .eq('board_id', boardId);
                
                if (notesError) {
                    console.error("Error deleting notes: ", notesError);
                    return;
                }
                
                // Then delete the board itself
                const { error: boardError } = await supabaseClient
                    .from('boards')
                    .delete()
                    .eq('id', boardId);
                
                if (boardError) {
                    console.error("Error deleting board: ", boardError);
                    alert("Error deleting board. Only the board creator can delete it.");
                    return;
                }
                
                console.log("Board deleted successfully");
                loadBoards();
            } catch (error) {
                console.error("Error deleting board: ", error);
                alert("Error deleting board. Only the board creator can delete it.");
            }
        }
        
        async function openBoard(boardId) {
            currentBoardId = boardId;
            
            try {
                // Get board name
                const { data, error } = await supabaseClient
                    .from('boards')
                    .select('*')
                    .eq('id', boardId)
                    .single();
                
                if (error) {
                    console.error("Error getting board: ", error);
                    return;
                }
                
                currentBoardName = data.name;
                currentBoardCreator = data.created_by;
                currentBoardNameSpan.textContent = currentBoardName;
                
                // Show rename button only if current user created this board
                if (currentBoardCreator === currentUser.id) {
                    renameBoardBtn.style.display = 'block';
                } else {
                    renameBoardBtn.style.display = 'none';
                }
                
                // Show the board UI
                boardSelection.style.display = 'none';
                corkboardContainer.style.display = 'block';
                boardHeader.style.display = 'flex';
                uploadContainer.style.display = 'flex';
                
                // Clear existing notes
                corkboard.innerHTML = '';
                
                // Load existing notes for this board
                loadBoardNotes(boardId);
                
                // Set up real-time listener for this board's notes
                setupRealtimeListener(boardId);
                
            } catch (error) {
                console.error("Error opening board: ", error);
            }
        }
        
        async function loadBoardNotes(boardId) {
            try {
                const { data, error } = await supabaseClient
                    .from('notes')
                    .select('*')
                    .eq('board_id', boardId);
                
                if (error) {
                    console.error("Error loading notes: ", error);
                    return;
                }
                
                data.forEach(note => {
                    addNoteToBoard(note);
                });
            } catch (error) {
                console.error("Error loading notes: ", error);
            }
        }
        
        function setupRealtimeListener(boardId) {
            if (unsubscribeNotes) {
              unsubscribeNotes.unsubscribe(); // remove previous listener if any
            }
            
            const channel = supabase.channel(`board-${boardId}`)
              .on(
                'postgres_changes',
                {
                  event: '*',
                  schema: 'public',
                  table: 'notes',
                  filter: `board_id=eq.${boardId}`
                },
                (payload) => {
                  console.log('Realtime change received:', payload);
            
                  if (payload.eventType === 'INSERT') addNoteToBoard(payload.new);
                  if (payload.eventType === 'UPDATE') updateNoteOnBoard(payload.new);
                  if (payload.eventType === 'DELETE') removeNoteFromBoard(payload.old.id);
                }
              )
              .subscribe();
            
            unsubscribeNotes = channel; // store reference to unsubscribe later
        }
        
        function showBoardSelection() {
            // Unsubscribe from notes listener
            if (unsubscribeNotes) {
                supabaseClient.removeChannel(unsubscribeNotes);
                unsubscribeNotes = null;
            }
            
            // Hide board UI and show selection
            corkboardContainer.style.display = 'none';
            boardHeader.style.display = 'none';
            uploadContainer.style.display = 'none';
            boardSelection.style.display = 'flex';
            
            // Reset scroll position
            corkboardContainer.scrollTop = 0;
            
            // Reload boards
            loadBoards();
        }
        
        // Upload image to Supabase Storage
        async function uploadImage(file) {
            try {
                // Generate a unique file name
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;
                const filePath = `images/${fileName}`;
                
                // Upload the image to Supabase Storage
                const { data, error } = await supabaseClient
                    .storage
                    .from('corkboard-images') // Replace with your bucket name
                    .upload(filePath, file);
                
                if (error) {
                    console.error("Error uploading image: ", error);
                    throw error;
                }
                
                // Get the public URL for the uploaded image
                const { data: { publicUrl } } = supabaseClient
                    .storage
                    .from('corkboard-images')
                    .getPublicUrl(filePath);
                
                return publicUrl;
            } catch (error) {
                console.error("Error in uploadImage: ", error);
                throw error;
            }
        }
        
        function addNoteToBoard(noteData) {
            // Check if note already exists
            if (document.querySelector(`[data-note-id="${noteData.id}"]`)) return;
            
            // Create container for note and pin
            const noteContainer = document.createElement('div');
            noteContainer.className = 'note-container';
            noteContainer.style.left = (noteData.x || 100) + 'px';
            noteContainer.style.top = (noteData.y || 100) + 'px';
            noteContainer.style.width = (noteData.width || 200) + 'px';
            noteContainer.style.height = (noteData.height || 200) + 'px';
            noteContainer.dataset.noteId = noteData.id;
            noteContainer.style.zIndex = noteData.z_index || highestZIndex++;
            
            // Create pin
            const pin = document.createElement('div');
            pin.className = 'pin';
            noteContainer.appendChild(pin);
            
            // Create note content
            let noteElement;
            
            if (noteData.type === 'image') {
                // Create pinned image element
                noteElement = document.createElement('div');
                noteElement.className = 'pinned-image';
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                
                const imgElement = document.createElement('img');
                imgElement.src = noteData.content;
                imgElement.onerror = function() {
                    console.error("Failed to load image:", noteData.content);
                    this.style.display = 'none';
                };
                noteElement.appendChild(imgElement);
                
            } else {
                // Create sticky note element
                noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                noteElement.setAttribute('data-color', noteData.color || 'yellow');
                
                if (noteData.type === 'text') {
                    const textElement = document.createElement('div');
                    textElement.className = 'note-text';
                    textElement.textContent = noteData.content;
                    noteElement.appendChild(textElement);
                }
            }
            
            noteContainer.appendChild(noteElement);
            
            // Add slight rotation for natural look
            const rotation = noteData.rotation || (Math.random() * 4 - 2);
            noteContainer.style.transform = `rotate(${rotation}deg)`;
            
            if (noteData.user_id === currentUser.id) {
                noteElement.classList.add('mine');
                
                // Add delete button for user's own notes
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('Delete this note?')) {
                        deleteNote(noteData.id);
                    }
                });
                noteElement.appendChild(deleteBtn);
            }
            
            // Add resize handle for ALL notes (everyone can resize)
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            noteElement.appendChild(resizeHandle);
            
            // Make resizable
            makeResizable(noteContainer, noteData.id);
            
            // Make draggable
            makeDraggable(noteContainer, noteData.id);
            
            // Bring to front on click
            noteContainer.addEventListener('mousedown', function(e) {
                if (!e.target.classList.contains('delete-btn') && 
                    !e.target.classList.contains('resize-handle')) {
                    bringToFront(noteContainer, noteData.id);
                }
            });
            
            corkboard.appendChild(noteContainer);
        }

        async function bringToFront(element, noteId) {
            highestZIndex++;
            element.style.zIndex = highestZIndex;
            
            // Update z-index in database
            try {
                const { error } = await supabaseClient
                    .from('notes')
                    .update({ z_index: highestZIndex })
                    .eq('id', noteId);
                
                if (error) {
                    console.error("Error updating z-index:", error);
                }
            } catch (error) {
                console.error("Error updating z-index:", error);
            }
        }

        function updateNoteOnBoard(noteData) {
            const noteContainer = document.querySelector(`[data-note-id="${noteData.id}"]`);
            if (noteContainer) {
                noteContainer.style.left = (noteData.x || 100) + 'px';
                noteContainer.style.top = (noteData.y || 100) + 'px';
                
                if (noteData.width && noteData.height) {
                    noteContainer.style.width = noteData.width + 'px';
                    noteContainer.style.height = noteData.height + 'px';
                }
                
                if (noteData.z_index) {
                    noteContainer.style.zIndex = noteData.z_index;
                    if (noteData.z_index > highestZIndex) {
                        highestZIndex = noteData.z_index;
                    }
                }
                
                if (noteData.type === 'text') {
                    const textElement = noteContainer.querySelector('.note-text');
                    if (textElement) textElement.textContent = noteData.content;
                }
            }
        }

        function removeNoteFromBoard(noteId) {
            const noteContainer = document.querySelector(`[data-note-id="${noteId}"]`);
            if (noteContainer) noteContainer.remove();
        }

        function makeDraggable(element, noteId) {
            let isDragging = false;
            let startX, startY;
            let startLeft, startTop;
            
            // Make both the pin and note draggable
            const pin = element.querySelector('.pin');
            const note = element.querySelector('.note, .pinned-image');
            
            [pin, note].forEach(draggableElement => {
                draggableElement.addEventListener('mousedown', function(e) {
                    // Don't start drag if clicking on delete button or resize handle
                    if (e.target.classList.contains('delete-btn') || 
                        e.target.classList.contains('resize-handle')) return;
                    
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // Get current position
                    startLeft = parseInt(element.style.left);
                    startTop = parseInt(element.style.top);
                    
                    element.style.zIndex = highestZIndex++;
                    e.preventDefault();
                });
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                const newX = startLeft + dx;
                const newY = startTop + dy;
                
                // Allow notes to be placed anywhere on the board
                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
            });
            
            document.addEventListener('mouseup', async function() {
                if (isDragging) {
                    isDragging = false;
                    
                    // Update position in database
                    try {
                        const { error } = await supabaseClient
                            .from('notes')
                            .update({
                                x: parseInt(element.style.left),
                                y: parseInt(element.style.top),
                                z_index: parseInt(element.style.zIndex)
                            })
                            .eq('id', noteId);
                        
                        if (error) {
                            console.error("Error updating note position:", error);
                        }
                    } catch (error) {
                        console.error("Error updating note position:", error);
                    }
                }
            });
        }

        function makeResizable(element, noteId) {
            let isResizing = false;
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;
            
            const resizeHandle = element.querySelector('.resize-handle');
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(element.style.width);
                startHeight = parseInt(element.style.height);
                startLeft = parseInt(element.style.left);
                startTop = parseInt(element.style.top);
                
                element.style.zIndex = highestZIndex++;
                e.stopPropagation();
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                // Calculate new dimensions with smaller minimum size constraints
                const newWidth = Math.max(80, startWidth + dx);
                const newHeight = Math.max(80, startHeight + dy);
                
                // Apply new size
                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';
            });
            
            document.addEventListener('mouseup', async function() {
                if (isResizing) {
                    isResizing = false;
                    
                    // Update size in database
                    try {
                        const { error } = await supabaseClient
                            .from('notes')
                            .update({
                                width: parseInt(element.style.width),
                                height: parseInt(element.style.height),
                                z_index: parseInt(element.style.zIndex)
                            })
                            .eq('id', noteId);
                        
                        if (error) {
                            console.error("Error updating note size:", error);
                        }
                    } catch (error) {
                        console.error("Error updating note size:", error);
                    }
                }
            });
        }

        // Add text note
        document.getElementById('add-text').addEventListener('click', async function() {
            const text = document.getElementById('text-note').value;
            if (text.trim()) {
                const newNote = {
                    id: 'note_' + Date.now(),
                    type: 'text',
                    content: text,
                    x: Math.random() * (corkboardContainer.offsetWidth - 200),
                    y: Math.random() * (corkboardContainer.offsetHeight - 200) + scrollY,
                    width: 200,
                    height: 200,
                    user_id: currentUser.id,
                    board_id: currentBoardId,
                    color: selectedColor,
                    rotation: Math.random() * 4 - 2,
                    z_index: highestZIndex++
                };
                
                try {
                    const { error } = await supabaseClient
                        .from('notes')
                        .insert([newNote]);
                    
                    if (error) {
                        console.error("Error adding text note:", error);
                        return;
                    }
                    
                    console.log("Text note added successfully");
                    document.getElementById('text-note').value = '';
                } catch (error) {
                    console.error("Error adding text note:", error);
                }
            }
        });

        // Add image note
        document.getElementById('add-image').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });
        
        document.getElementById('image-upload').addEventListener('change', async function() {
            if (this.files && this.files[0]) {
                try {
                    // Upload the image to Supabase Storage
                    const imageUrl = await uploadImage(this.files[0]);
                    
                    const newNote = {
                        id: 'note_' + Date.now(),
                        type: 'image',
                        content: imageUrl,
                        x: Math.random() * (corkboardContainer.offsetWidth - 200),
                        y: Math.random() * (corkboardContainer.offsetHeight - 200) + scrollY,
                        width: 200,
                        height: 200,
                        user_id: currentUser.id,
                        board_id: currentBoardId,
                        rotation: Math.random() * 4 - 2,
                        z_index: highestZIndex++
                    };
                    
                    // Save to Supabase
                    const { error } = await supabaseClient
                        .from('notes')
                        .insert([newNote]);
                    
                    if (error) {
                        console.error("Error adding image note:", error);
                        return;
                    }
                    
                    console.log("Image note added successfully");
                    
                } catch (error) {
                    console.error("Error adding image note:", error);
                }
                this.value = ''; // Reset file input
            }
        });

        // Delete a note
        async function deleteNote(noteId) {
            try {
                const { error } = await supabaseClient
                    .from('notes')
                    .delete()
                    .eq('id', noteId);
                
                if (error) {
                    console.error("Error deleting note:", error);
                }
            } catch (error) {
                console.error("Error deleting note:", error);
            }
        }

        // Double-click to edit text notes
        document.addEventListener('dblclick', async function(e) {
            if (e.target.classList.contains('note-text')) {
                const textElement = e.target;
                const noteContainer = textElement.closest('.note-container');
                const noteId = noteContainer.dataset.noteId;
                const currentText = textElement.textContent;
                
                if (noteContainer.querySelector('.note').classList.contains('mine')) {
                    const newText = prompt('Edit your note:', currentText);
                    
                    if (newText !== null) {
                        try {
                            const { error } = await supabaseClient
                                .from('notes')
                                .update({ content: newText })
                                .eq('id', noteId);
                            
                            if (error) {
                                console.error("Error updating note text:", error);
                            }
                        } catch (error) {
                            console.error("Error updating note text:", error);
                        }
                    }
                }
            }
        });
        
        // Color selection
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                selectedColor = this.getAttribute('data-color');
            });
        });
    </script>
</body>
</html>
