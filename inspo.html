<!DOCTYPE html>
<html>
<head>
    <title>Inspiration Corkboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('Images/corkboard.png');
            background-size: cover;
            background-color: #8b5a2b;
            font-family: 'Comic Sans MS', cursive;
            height: 100vh;
            overflow: hidden;
            position: relative;
            cursor: default;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .corkboard-frame {
            width: 98vw;
            height: 96vh;
            border: 12px solid #ffebf1;
            border-radius: 4px;
            box-shadow: 
                0 0 0 4px #8b4513,
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                0 8px 20px rgba(0, 0, 0, 0.5);
            background-size: cover;
            position: relative;
            overflow: hidden;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        #upload-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        #text-note {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Comic Sans MS', cursive;
            width: 200px;
        }
        
        button {
            padding: 8px 12px;
            background: #ffcc00;
            border: none;
            border-radius: 4px;
            font-family: 'Comic Sans MS', cursive;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #ffdb4d;
            transform: translateY(-2px);
        }
        
        #corkboard {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: visible;
            z-index: 1;
        }
        
        .note-container {
            position: absolute;
            z-index: 10;
        }
        
        .note {
            position: relative;
            min-width: 150px;
            min-height: 150px;
            padding: 15px;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: box-shadow 0.3s;
            overflow: hidden;
        }
        
        .note.mine {
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .note-container:hover {
            z-index: 20;
        }
        
        .pin {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background-image: url('Images/thumbtack.png');
            background-size: contain;
            background-repeat: no-repeat;
            cursor: move;
            z-index: 25;
        }
        
        .note-text {
            width: 100%;
            min-height: 100px;
            background: transparent;
            border: none;
            resize: none;
            font-family: 'Comic Sans MS', cursive;
            font-size: 16px;
            outline: none;
            flex-grow: 1;
            margin-top: 5px;
            padding: 5px;
            overflow-wrap: break-word;
            cursor: text;
            overflow: auto;
        }
        
        .note img {
            max-width: 100%;
            max-height: 200px;
            margin-top: 5px;
            object-fit: contain;
        }
        
        .pinned-image {
            box-shadow: 3px 3px 15px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            background: transparent;
        }
        
        .pinned-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 30;
        }
        
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            right: 2px;
            bottom: 2px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 25;
        }
        
        .note-container:hover .delete-btn,
        .note-container:hover .resize-handle {
            opacity: 1;
        }
        
        /* Sticky note colors */
        .note[data-color="yellow"] { background: linear-gradient(135deg, #fffc7f 0%, #fdfb90 100%); }
        .note[data-color="pink"] { background: linear-gradient(135deg, #ff9ee0 0%, #fdcdea 100%); }
        .note[data-color="blue"] { background: linear-gradient(135deg, #a2d2ff 0%, #c6e2ff 100%); }
        .note[data-color="green"] { background: linear-gradient(135deg, #b0f2b6 0%, #caf7ce 100%); }
        .note[data-color="purple"] { background: linear-gradient(135deg, #d9b0ff 0%, #e6ceff 100%); }
        
        /* Rotation for more natural look */
        .note-container {
            transform: rotate(calc(-2deg + 4deg * random()));
        }
        
        /* Color picker */
        .color-picker {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-option.active {
            border-color: #333;
        }
        
        #yellow { background: #fffc7f; }
        #pink { background: #ff9ee0; }
        #blue { background: #a2d2ff; }
        #green { background: #b0f2b6; }
        #purple { background: #d9b0ff; }
        
        /* Instructions */
        .instructions {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 101;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 20px;
        }
        
        .instructions.collapsed {
            max-height: 20px;
            cursor: pointer;
        }
        
        .instructions.expanded {
            max-height: 200px;
            cursor: default;
        }
        
        .instructions h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .instructions ul {
            margin: 0;
            padding-left: 15px;
        }
        
        .toggle-instructions {
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading corkboard...</div>

    <div class="instructions collapsed" id="instructions">
        <h3>How to use <span class="toggle-instructions">+</span></h3>
        <div class="content">
            <ul>
                <li>Drag notes/images to move (grab by the pin)</li>
                <li>Use resize handle (bottom-right) to resize</li>
                <li>Double-click text to edit</li>
                <li>Click × to delete your notes</li>
                <li>Click on any note to bring it to the front</li>
            </ul>
        </div>
    </div>

    <div class="corkboard-frame">
        <div id="corkboard">
            <!-- Notes and images will appear here -->
        </div>
    </div>

    <div id="upload-container">
        <input type="text" id="text-note" placeholder="Write your note...">
        <div class="color-picker">
            <div class="color-option active" id="yellow" data-color="yellow"></div>
            <div class="color-option" id="pink" data-color="pink"></div>
            <div class="color-option" id="blue" data-color="blue"></div>
            <div class="color-option" id="green" data-color="green"></div>
            <div class="color-option" id="purple" data-color="purple"></div>
        </div>
        <input type="file" id="image-upload" accept="image/*" style="display: none;">
        <button id="add-text">Add Text Note</button>
        <button id="add-image">Add Image</button>
    </div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4izdi6kTnyr2OwYyM9hr69wwVqiVrZl8",
            authDomain: "inspocorkboard.firebaseapp.com",
            projectId: "inspocorkboard",
            storageBucket: "inspocorkboard.firebasestorage.app",
            messagingSenderId: "1055098716394",
            appId: "1:1055098716394:web:bd01f225db45d42f405793",
            measurementId: "G-EN7B83205B"
        };

        // Initialize Firebase (using compat version)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // User and notes variables
        let currentUser = null;
        let notes = [];
        let selectedColor = 'yellow';
        let highestZIndex = 10;

        // DOM elements
        const corkboard = document.getElementById('corkboard');
        const loadingElement = document.getElementById('loading');
        const instructions = document.getElementById('instructions');
        const corkboardFrame = document.querySelector('.corkboard-frame');

        // Initialize app
        initApp();

        // Toggle instructions
        instructions.addEventListener('click', function(e) {
            if (e.target.classList.contains('toggle-instructions') || e.target.tagName === 'H3') {
                if (instructions.classList.contains('collapsed')) {
                    instructions.classList.remove('collapsed');
                    instructions.classList.add('expanded');
                    document.querySelector('.toggle-instructions').textContent = '-';
                } else {
                    instructions.classList.remove('expanded');
                    instructions.classList.add('collapsed');
                    document.querySelector('.toggle-instructions').textContent = '+';
                }
            }
        });

         async function initApp() {
            try {
                console.log("Initializing Firebase...");
                
                // Sign in anonymously
                console.log("Attempting anonymous sign-in...");
                const cred = await auth.signInAnonymously();
                currentUser = auth.currentUser;
                console.log("Signed in successfully. User ID:", currentUser.uid);
                
                // Load existing notes
                loadNotes();
                
                // Set up real-time listener
                db.collection("notes").onSnapshot(snapshot => {
                    console.log("Received snapshot with", snapshot.docs.length, "notes");
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            addNoteToBoard(change.doc.data());
                        }
                        if (change.type === "modified") {
                            updateNoteOnBoard(change.doc.data());
                        }
                        if (change.type === "removed") {
                            removeNoteFromBoard(change.doc.id);
                        }
                    });
                }, error => {
                    console.error("Firestore listener error:", error);
                });
                
                loadingElement.style.display = 'none';
            } catch (error) {
                console.error("Initialization error:", error);
                console.error("Full error details:", JSON.stringify(error, null, 2));
                loadingElement.textContent = `Error: ${error.message}`;
            }
        }
        
        // Add this function to compress images
        function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed data URL
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function loadNotes() {
            db.collection("notes").get().then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    addNoteToBoard(doc.data());
                });
            }).catch(error => {
                console.error("Error loading notes:", error);
            });
        }

        function addNoteToBoard(noteData) {
            // Check if note already exists
            if (document.querySelector(`[data-note-id="${noteData.id}"]`)) return;
            
            // Create container for note and pin
            const noteContainer = document.createElement('div');
            noteContainer.className = 'note-container';
            noteContainer.style.left = (noteData.x || 100) + 'px';
            noteContainer.style.top = (noteData.y || 100) + 'px';
            noteContainer.style.width = (noteData.width || 200) + 'px';
            noteContainer.style.height = (noteData.height || 200) + 'px';
            noteContainer.dataset.noteId = noteData.id;
            noteContainer.style.zIndex = noteData.zIndex || highestZIndex++;
            
            // Create pin
            const pin = document.createElement('div');
            pin.className = 'pin';
            noteContainer.appendChild(pin);
            
            // Create note content
            let noteElement;
            
            if (noteData.type === 'image') {
                // Create pinned image element
                noteElement = document.createElement('div');
                noteElement.className = 'pinned-image';
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                
                const imgElement = document.createElement('img');
                imgElement.src = noteData.content;
                imgElement.onerror = function() {
                    console.error("Failed to load image:", noteData.content);
                    this.style.display = 'none';
                };
                noteElement.appendChild(imgElement);
                
            } else {
                // Create sticky note element
                noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                noteElement.setAttribute('data-color', noteData.color || 'yellow');
                
                if (noteData.type === 'text') {
                    const textElement = document.createElement('div');
                    textElement.className = 'note-text';
                    textElement.textContent = noteData.content;
                    noteElement.appendChild(textElement);
                }
            }
            
            noteContainer.appendChild(noteElement);
            
            // Add slight rotation for natural look
            const rotation = noteData.rotation || (Math.random() * 4 - 2);
            noteContainer.style.transform = `rotate(${rotation}deg)`;
            
            if (noteData.userId === currentUser.uid) {
                noteElement.classList.add('mine');
                
                // Add delete button for user's own notes
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('Delete this note?')) {
                        db.collection("notes").doc(noteData.id).delete().catch(error => {
                            console.error("Error deleting note:", error);
                        });
                    }
                });
                noteElement.appendChild(deleteBtn);
                
                // Add resize handle for user's own notes
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                noteElement.appendChild(resizeHandle);
                
                // Make resizable
                makeResizable(noteContainer, noteData.id);
            }
            
            // Make draggable
            makeDraggable(noteContainer, noteData.id);
            
            // Bring to front on click
            noteContainer.addEventListener('mousedown', function(e) {
                if (!e.target.classList.contains('delete-btn') && 
                    !e.target.classList.contains('resize-handle')) {
                    bringToFront(noteContainer, noteData.id);
                }
            });
            
            corkboard.appendChild(noteContainer);
        }

        function bringToFront(element, noteId) {
            highestZIndex++;
            element.style.zIndex = highestZIndex;
            
            // Update z-index in database
            db.collection("notes").doc(noteId).update({
                zIndex: highestZIndex
            }).catch(error => {
                console.error("Error updating z-index:", error);
            });
        }

        function updateNoteOnBoard(noteData) {
            const noteContainer = document.querySelector(`[data-note-id="${noteData.id}"]`);
            if (noteContainer) {
                noteContainer.style.left = (noteData.x || 100) + 'px';
                noteContainer.style.top = (noteData.y || 100) + 'px';
                
                if (noteData.width && noteData.height) {
                    noteContainer.style.width = noteData.width + 'px';
                    noteContainer.style.height = noteData.height + 'px';
                }
                
                if (noteData.zIndex) {
                    noteContainer.style.zIndex = noteData.zIndex;
                    if (noteData.zIndex > highestZIndex) {
                        highestZIndex = noteData.zIndex;
                    }
                }
                
                if (noteData.type === 'text') {
                    const textElement = noteContainer.querySelector('.note-text');
                    if (textElement) textElement.textContent = noteData.content;
                }
            }
        }

        function removeNoteFromBoard(noteId) {
            const noteContainer = document.querySelector(`[data-note-id="${noteId}"]`);
            if (noteContainer) noteContainer.remove();
        }

        function makeDraggable(element, noteId) {
            let isDragging = false;
            let startX, startY;
            let startLeft, startTop;
            
            // Make both the pin and note draggable
            const pin = element.querySelector('.pin');
            const note = element.querySelector('.note, .pinned-image');
            
            [pin, note].forEach(draggableElement => {
                draggableElement.addEventListener('mousedown', function(e) {
                    // Don't start drag if clicking on delete button or resize handle
                    if (e.target.classList.contains('delete-btn') || 
                        e.target.classList.contains('resize-handle')) return;
                    
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // Get current position
                    startLeft = parseInt(element.style.left);
                    startTop = parseInt(element.style.top);
                    
                    element.style.zIndex = highestZIndex++;
                    e.preventDefault();
                });
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                const newX = startLeft + dx;
                const newY = startTop + dy;
                
                // Allow notes to be placed anywhere on the board
                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    
                    // Update position in database
                    db.collection("notes").doc(noteId).update({
                        x: parseInt(element.style.left),
                        y: parseInt(element.style.top),
                        zIndex: parseInt(element.style.zIndex)
                    }).catch(error => {
                        console.error("Error updating note position:", error);
                    });
                }
            });
        }

        function makeResizable(element, noteId) {
            let isResizing = false;
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;
            
            const resizeHandle = element.querySelector('.resize-handle');
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(element.style.width);
                startHeight = parseInt(element.style.height);
                startLeft = parseInt(element.style.left);
                startTop = parseInt(element.style.top);
                
                element.style.zIndex = highestZIndex++;
                e.stopPropagation();
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                // Calculate new dimensions with minimum size constraints
                const newWidth = Math.max(150, startWidth + dx);
                const newHeight = Math.max(150, startHeight + dy);
                
                // Apply new size
                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    
                    // Update size in database
                    db.collection("notes").doc(noteId).update({
                        width: parseInt(element.style.width),
                        height: parseInt(element.style.height),
                        zIndex: parseInt(element.style.zIndex)
                    }).catch(error => {
                        console.error("Error updating note size:", error);
                    });
                }
            });
        }

        // Add text note
        document.getElementById('add-text').addEventListener('click', function() {
            const text = document.getElementById('text-note').value;
            if (text.trim()) {
                const newNote = {
                    id: 'note_' + Date.now(),
                    type: 'text',
                    content: text,
                    x: Math.random() * (corkboardFrame.offsetWidth - 200),
                    y: Math.random() * (corkboardFrame.offsetHeight - 200),
                    width: 200,
                    height: 200,
                    userId: currentUser.uid,
                    color: selectedColor,
                    rotation: Math.random() * 4 - 2,
                    zIndex: highestZIndex++,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                db.collection("notes").doc(newNote.id).set(newNote)
                    .then(() => {
                        console.log("Text note added successfully");
                        document.getElementById('text-note').value = '';
                    })
                    .catch(error => {
                        console.error("Error adding text note:", error);
                    });
            }
        });

        // Add image note
        document.getElementById('add-image').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });
        
        document.getElementById('image-upload').addEventListener('change', async function() {
            if (this.files && this.files[0]) {
                try {
                    // Compress the image first
                    const compressedDataUrl = await compressImage(this.files[0]);
                    
                    const newNote = {
                        id: 'note_' + Date.now(),
                        type: 'image',
                        content: compressedDataUrl, // Use compressed image
                         x: Math.random() * (corkboardFrame.offsetWidth - 200),
                        y: Math.random() * (corkboardFrame.offsetHeight - 200),
                        width: 200,
                        height: 200,
                        userId: currentUser.uid,
                        rotation: Math.random() * 4 - 2,
                        zIndex: highestZIndex++,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Save to Firebase
                    await db.collection("notes").doc(newNote.id).set(newNote);
                    console.log("Image note added successfully");
                    
                } catch (error) {
                    console.error("Error adding image note:", error);
                }
                this.value = ''; // Reset file input
            }
        });

        // Double-click to edit text notes
        document.addEventListener('dblclick', function(e) {
            if (e.target.classList.contains('note-text')) {
                const textElement = e.target;
                const noteContainer = textElement.closest('.note-container');
                const noteId = noteContainer.dataset.noteId;
                const currentText = textElement.textContent;
                
                if (noteContainer.querySelector('.note').classList.contains('mine')) {
                    const newText = prompt('Edit your note:', currentText);
                    
                    if (newText !== null) {
                        db.collection("notes").doc(noteId).update({
                            content: newText
                        }).catch(error => {
                            console.error("Error updating note text:", error);
                        });
                    }
                }
            }
        });
        
        // Color selection
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                selectedColor = this.getAttribute('data-color');
            });
        });
    </script>
</body>
</html>
