<!DOCTYPE html>
<html>
<head>
    <title>Inspiration Corkboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #ffd1dc, #ffcce5);
            font-family: 'Nunito', 'Comic Sans MS', cursive, sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            cursor: default;
        }
        
        /* Decorative elements */
        .floating-hearts {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .heart {
            position: absolute;
            opacity: 0.3;
            animation: float 8s infinite ease-in-out;
        }
        
        .heart::before, .heart::after {
            content: '';
            background-color: #ff9ebb;
            position: absolute;
            width: 10px;
            height: 16px;
            border-radius: 50%;
        }
        
        .heart::before {
            transform: rotate(-45deg);
            left: 5px;
        }
        
        .heart::after {
            transform: rotate(45deg);
            right: 5px;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        
        /* Board selection screen */
        #board-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #ffd1dc, #ffcce5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        #board-selection h2 {
            color: #d44d8c;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.2rem;
            text-shadow: 2px 2px 0px #fff;
        }
        
        .boards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin-bottom: 30px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(134, 80, 108, 0.2);
        }
        
        .board-item {
            background: linear-gradient(145deg, #f8c5e0, #d9a8e3);
            padding: 20px;
            border-radius: 15px;
            width: 160px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: #7a3c6c;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .board-item::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ff9ec9, #d9a8e3, #a2d2ff);
            z-index: -1;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .board-item:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .board-item:hover::after {
            opacity: 0.3;
        }
        
        .board-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .board-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 15px;
            border: none;
            background: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .board-actions button:hover {
            background: white;
            transform: scale(1.1);
        }
        
        #create-board {
            background: linear-gradient(to right, #ff85c0, #ff6b9c);
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            cursor: pointer;
            font-size: 18px;
            margin-top: 20px;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 107, 156, 0.4);
            transition: all 0.3s ease;
        }
        
        #create-board:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 156, 0.6);
        }
        
        #create-board-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(to bottom, #ffc2e2, #f9b8e2);
            padding: 25px;
            border-radius: 20px;
            margin-top: 20px;
            align-items: center;
            box-shadow: 0 8px 25px rgba(134, 80, 108, 0.2);
            border: 2px dashed #ff9ec9;
        }
        
        #new-board-name {
            padding: 12px 15px;
            border: 2px solid #ff9ec9;
            border-radius: 20px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            width: 280px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* Corkboard styling */
        .corkboard-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            padding: 20px;
        }
        
        .corkboard-frame {
            width: 98vw;
            height: 5000px;
            border: 25px solid #b07c57;
            border-radius: 12px;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.4),
                0 10px 25px rgba(0, 0, 0, 0.4);
            background-image: 
                radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(135deg, #a5724b 0%, #b07c57 100%);
            background-size: 20px 20px, 100% 100%;
            position: relative;
            margin: 0 auto;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 230, 240, 0.95);
            padding: 25px;
            border-radius: 20px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            color: #d44d8c;
            font-weight: bold;
        }
        
        #upload-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 230, 240, 0.9);
            padding: 18px;
            border-radius: 50px;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 100;
            border: 2px solid #ffc2e2;
        }
        
        #text-note {
            padding: 12px 18px;
            border: 2px solid #ff9ec9;
            border-radius: 25px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            width: 220px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        button {
            padding: 10px 18px;
            background: linear-gradient(to right, #ff9ec9, #ff85c0);
            border: none;
            border-radius: 25px;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 158, 201, 0.4);
        }
        
        button:hover {
            background: linear-gradient(to right, #ff85c0, #ff6b9c);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 158, 201, 0.6);
        }
        
        #corkboard {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: visible;
            z-index: 1;
        }
        
        .note-container {
            position: absolute;
            z-index: 10;
            filter: drop-shadow(4px 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .note {
            position: relative;
            min-width: 100px;
            min-height: 100px;
            padding: 20px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            overflow: hidden;
            border-radius: 10px;
        }
        
        .note.mine {
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.25);
        }
        
        .note-container:hover {
            z-index: 20;
        }
        
        .pin {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, #ff6b9c 30%, #d44d8c 100%);
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            cursor: move;
            z-index: 25;
        }
        
        .pin::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
        }
        
        .note-text {
            width: 100%;
            min-height: 60px;
            background: transparent;
            border: none;
            resize: none;
            font-family: 'Nunito', 'Comic Sans MS', cursive;
            font-size: 16px;
            outline: none;
            flex-grow: 1;
            margin-top: 8px;
            padding: 8px;
            overflow-wrap: break-word;
            cursor: text;
            overflow: auto;
            border-radius: 8px;
        }
        
        .note img {
            max-width: 100%;
            max-height: 220px;
            margin-top: 8px;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .pinned-image {
            box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            background: transparent;
            border-radius: 10px;
        }
        
        .pinned-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(to right, #ff6b6b, #ff4f4f);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 30;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: rgba(255, 158, 201, 0.7);
            border-radius: 50%;
            right: 4px;
            bottom: 4px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 25;
        }
        
        .note-container:hover .delete-btn,
        .note-container:hover .resize-handle {
            opacity: 1;
        }
        
        /* Sticky note colors */
        .note[data-color="yellow"] { 
            background: linear-gradient(135deg, #fff8b3 0%, #fff5a0 100%); 
            border: 2px solid #fff176;
        }
        .note[data-color="pink"] { 
            background: linear-gradient(135deg, #ffbde1 0%, #ffa5d6 100%); 
            border: 2px solid #ff9ec9;
        }
        .note[data-color="blue"] { 
            background: linear-gradient(135deg, #b5deff 0%, #a2d2ff 100%); 
            border: 2px solid #89c2ff;
        }
        .note[data-color="green"] { 
            background: linear-gradient(135deg, #c5f7cb 0%, #b0f2b6 100%); 
            border: 2px solid #9eeaa5;
        }
        .note[data-color="purple"] { 
            background: linear-gradient(135deg, #e2c5ff 0%, #d9b0ff 100%); 
            border: 2px solid #c995ff;
        }
        .note[data-color="lavender"] { 
            background: linear-gradient(135deg, #e6e6ff 0%, #d6d1ff 100%); 
            border: 2px solid #c9c1ff;
        }
        
        /* Rotation for more natural look */
        .note-container {
            transform: rotate(calc(-3deg + 6deg * random()));
        }
        
        /* Color picker */
        .color-picker {
            display: flex;
            gap: 8px;
            margin-left: 15px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px;
            border-radius: 25px;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.15);
        }
        
        .color-option.active {
            border-color: #7a3c6c;
            transform: scale(1.2);
        }
        
        #yellow { background: #fff8b3; }
        #pink { background: #ffbde1; }
        #blue { background: #b5deff; }
        #green { background: #c5f7cb; }
        #purple { background: #e2c5ff; }
        #lavender { background: #e6e6ff; }
        
        /* Instructions */
        .instructions {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 230, 240, 0.9);
            padding: 15px;
            border-radius: 15px;
            font-size: 14px;
            max-width: 220px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 101;
            border: 2px solid #ffc2e2;
            color: #7a3c6c;
        }
        
        .instructions h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #d44d8c;
        }
        
        .instructions ul {
            margin: 0;
            padding-left: 18px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .toggle-instructions {
            font-size: 18px;
            cursor: pointer;
            color: #ff6b9c;
        }
        
        /* Board header */
        #board-header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 230, 240, 0.9);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 101;
            border: 2px solid #ffc2e2;
        }
        
        #back-to-boards {
            background: linear-gradient(to right, #d44d8c, #b13c7a);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #rename-board {
            background: linear-gradient(to right, #7a3c6c, #5e2a55);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 16px;
        }
        
        ::-webkit-scrollbar-track {
            background: #ffd1dc;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #ff9ec9, #ff85c0);
            border-radius: 8px;
            border: 3px solid #ffd1dc;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #ff85c0, #ff6b9c);
        }
    </style>

</head>
<body>
    <div id="board-selection">
        <h2>Select a Corkboard</h2>
        <div class="boards-container" id="boards-list">
            <!-- Boards will be listed here -->
        </div>
        <button id="create-board">Create New Board</button>
        <div id="create-board-form" style="display: none;">
            <input type="text" id="new-board-name" placeholder="Board name">
            <button id="submit-new-board">Create</button>
        </div>
    </div>

    <div class="loading" id="loading">Loading corkboard...</div>

    <div id="board-header" style="display: none;">
        <span id="current-board-name">My Board</span>
        <button id="back-to-boards">Back to Boards</button>
        <button id="rename-board" style="display: none;">Rename Board</button>
    </div>

    <div class="instructions" id="instructions">
        <h3>How to use <span class="toggle-instructions"> +</span></h3>
        <div class="content" style="display: none;">
            <ul>
                <li>Drag notes/images to move (grab by the pin)</li>
                <li>Use resize handle (bottom-right) to resize</li>
                <li>Double-click text to edit</li>
                <li>Click × to delete your notes</li>
                <li>Click on any note to bring it to the front</li>
                <li>Scroll to explore more space on the board</li>
            </ul>
        </div>
    </div>

    <div class="corkboard-container" id="corkboard-container" style="display: none;">
        <div class="corkboard-frame">
            <div id="corkboard">
                <!-- Notes and images will appear here -->
            </div>
        </div>
    </div>

    <div id="upload-container" style="display: none;">
        <input type="text" id="text-note" placeholder="Write your note...">
        <div class="color-picker">
            <div class="color-option active" id="yellow" data-color="yellow"></div>
            <div class="color-option" id="pink" data-color="pink"></div>
            <div class="color-option" id="blue" data-color="blue"></div>
            <div class="color-option" id="green" data-color="green"></div>
            <div class="color-option" id="purple" data-color="purple"></div>
        </div>
        <input type="file" id="image-upload" accept="image/*" style="display: none;">
        <button id="add-text">Add Text Note</button>
        <button id="add-image">Add Image</button>
    </div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4izdi6kTnyr2OwYyM9hr69wwVqiVrZl8",
            authDomain: "inspocorkboard.firebaseapp.com",
            projectId: "inspocorkboard",
            storageBucket: "inspocorkboard.firebasestorage.app",
            messagingSenderId: "1055098716394",
            appId: "1:1055098716394:web:bd01f225db45d42f405793",
            measurementId: "G-EN7B83205B"
        };

        // Initialize Firebase (using compat version)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // User and notes variables
        let currentUser = null;
        let notes = [];
        let selectedColor = 'yellow';
        let highestZIndex = 10;
        let currentBoardId = null;
        let currentBoardName = "";
        let currentBoardCreator = "";
        let unsubscribeNotes = null;
        let scrollY = 0;

        // DOM elements
        const corkboard = document.getElementById('corkboard');
        const loadingElement = document.getElementById('loading');
        const instructions = document.getElementById('instructions');
        const toggleInstructions = document.querySelector('.toggle-instructions');
        const instructionsContent = document.querySelector('.instructions .content');
        const corkboardContainer = document.getElementById('corkboard-container');
        const boardSelection = document.getElementById('board-selection');
        const boardsList = document.getElementById('boards-list');
        const createBoardBtn = document.getElementById('create-board');
        const createBoardForm = document.getElementById('create-board-form');
        const submitNewBoardBtn = document.getElementById('submit-new-board');
        const newBoardNameInput = document.getElementById('new-board-name');
        const boardHeader = document.getElementById('board-header');
        const currentBoardNameSpan = document.getElementById('current-board-name');
        const backToBoardsBtn = document.getElementById('back-to-boards');
        const renameBoardBtn = document.getElementById('rename-board');
        const uploadContainer = document.getElementById('upload-container');

        // Initialize app
        initApp();

        // Toggle instructions (original functionality)
        toggleInstructions.addEventListener('click', function() {
            if (instructionsContent.style.display === 'none') {
                instructionsContent.style.display = 'block';
                toggleInstructions.textContent = '-';
            } else {
                instructionsContent.style.display = 'none';
                toggleInstructions.textContent = '+';
            }
        });

        // Board selection functionality
        createBoardBtn.addEventListener('click', function() {
            createBoardForm.style.display = 'flex';
            createBoardBtn.style.display = 'none'; // Hide create button after clicking
        });

        submitNewBoardBtn.addEventListener('click', function() {
            const boardName = newBoardNameInput.value.trim();
            if (boardName) {
                createNewBoard(boardName);
            }
        });

        backToBoardsBtn.addEventListener('click', function() {
            showBoardSelection();
        });

        renameBoardBtn.addEventListener('click', function() {
            const newName = prompt("Enter new name for this board:", currentBoardName);
            if (newName && newName.trim() !== "") {
                renameBoard(currentBoardId, newName.trim());
            }
        });

        // Track scroll position (vertical only)
        corkboardContainer.addEventListener('scroll', function() {
            scrollY = this.scrollTop;
        });

        async function initApp() {
            try {
                console.log("Initializing Firebase...");
                
                // Sign in anonymously
                console.log("Attempting anonymous sign-in...");
                const cred = await auth.signInAnonymously();
                currentUser = auth.currentUser;
                console.log("Signed in successfully. User ID:", currentUser.uid);
                
                // Load boards
                loadBoards();
                
                loadingElement.style.display = 'none';
            } catch (error) {
                console.error("Initialization error:", error);
                console.error("Full error details:", JSON.stringify(error, null, 2));
                loadingElement.textContent = `Error: ${error.message}`;
            }
        }
        
        function loadBoards() {
            db.collection("boards").get().then(querySnapshot => {
                boardsList.innerHTML = '';
                if (querySnapshot.empty) {
                    boardsList.innerHTML = '<p style="color: white;">No boards yet. Create the first one!</p>';
                    createBoardBtn.style.display = 'block'; // Show create button if no boards
                } else {
                    querySnapshot.forEach(doc => {
                        const boardData = doc.data();
                        const boardItem = document.createElement('div');
                        boardItem.className = 'board-item';
                        boardItem.dataset.boardId = doc.id;
                        
                        let actionsHtml = `<button class="open-board" data-id="${doc.id}">Open</button>`;
                        
                        // Only show delete button for boards created by current user
                        if (boardData.createdBy === currentUser.uid) {
                            actionsHtml += `<button class="delete-board" data-id="${doc.id}">Delete</button>`;
                        }
                        
                        boardItem.innerHTML = `
                            <h3 class="board-name">${boardData.name}</h3>
                            <div class="board-actions">
                                ${actionsHtml}
                            </div>
                        `;
                        boardsList.appendChild(boardItem);
                        
                        // Add double-click event for renaming (only for creator)
                        if (boardData.createdBy === currentUser.uid) {
                            const boardNameElement = boardItem.querySelector('.board-name');
                            boardNameElement.addEventListener('dblclick', function(e) {
                                e.stopPropagation();
                                const newName = prompt("Enter new name for this board:", boardData.name);
                                if (newName && newName.trim() !== "") {
                                    renameBoard(doc.id, newName.trim());
                                }
                            });
                        }
                    });
                    
                    // Add event listeners
                    document.querySelectorAll('.open-board').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const boardId = this.getAttribute('data-id');
                            openBoard(boardId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-board').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const boardId = this.getAttribute('data-id');
                            if (confirm('Are you sure you want to delete this board?')) {
                                deleteBoard(boardId);
                            }
                        });
                    });
                }
            }).catch(error => {
                console.error("Error loading boards:", error);
            });
        }
        
        function createNewBoard(name) {
            const newBoard = {
                name: name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            };
            
            db.collection("boards").add(newBoard)
                .then((docRef) => {
                    console.log("Board created with ID: ", docRef.id);
                    newBoardNameInput.value = '';
                    createBoardForm.style.display = 'none';
                    createBoardBtn.style.display = 'block'; // Show create button again
                    openBoard(docRef.id);
                })
                .catch(error => {
                    console.error("Error creating board: ", error);
                });
        }
        
        function renameBoard(boardId, newName) {
            db.collection("boards").doc(boardId).update({
                name: newName
            })
            .then(() => {
                console.log("Board renamed successfully");
                currentBoardName = newName;
                currentBoardNameSpan.textContent = newName;
                
                // Update the board name in the selection list too
                loadBoards();
            })
            .catch(error => {
                console.error("Error renaming board: ", error);
                alert("Error renaming board. Only the board creator can rename it.");
            });
        }
        
        function deleteBoard(boardId) {
            // First delete all notes in this board
            db.collection("notes")
                .where("boardId", "==", boardId)
                .get()
                .then(querySnapshot => {
                    const deletePromises = [];
                    querySnapshot.forEach(doc => {
                        deletePromises.push(doc.ref.delete());
                    });
                    
                    return Promise.all(deletePromises);
                })
                .then(() => {
                    // Then delete the board itself
                    return db.collection("boards").doc(boardId).delete();
                })
                .then(() => {
                    console.log("Board deleted successfully");
                    loadBoards();
                })
                .catch(error => {
                    console.error("Error deleting board: ", error);
                    alert("Error deleting board. Only the board creator can delete it.");
                });
        }
        
        function openBoard(boardId) {
            currentBoardId = boardId;
            
            // Get board name
            db.collection("boards").doc(boardId).get()
                .then(doc => {
                    if (doc.exists) {
                        const boardData = doc.data();
                        currentBoardName = boardData.name;
                        currentBoardCreator = boardData.createdBy;
                        currentBoardNameSpan.textContent = currentBoardName;
                        
                        // Show rename button only if current user created this board
                        if (currentBoardCreator === currentUser.uid) {
                            renameBoardBtn.style.display = 'block';
                        } else {
                            renameBoardBtn.style.display = 'none';
                        }
                        
                        // Show the board UI
                        boardSelection.style.display = 'none';
                        corkboardContainer.style.display = 'block';
                        boardHeader.style.display = 'flex';
                        uploadContainer.style.display = 'flex';
                        
                        // Clear existing notes
                        corkboard.innerHTML = '';
                        
                        // Set up real-time listener for this board's notes
                        if (unsubscribeNotes) {
                            unsubscribeNotes(); // Remove previous listener if any
                        }
                        
                        unsubscribeNotes = db.collection("notes")
                            .where("boardId", "==", boardId)
                            .onSnapshot(snapshot => {
                                console.log("Received snapshot with", snapshot.docs.length, "notes");
                                snapshot.docChanges().forEach(change => {
                                    if (change.type === "added") {
                                        addNoteToBoard(change.doc.data());
                                    }
                                    if (change.type === "modified") {
                                        updateNoteOnBoard(change.doc.data());
                                    }
                                    if (change.type === "removed") {
                                        removeNoteFromBoard(change.doc.id);
                                    }
                                });
                            }, error => {
                                console.error("Firestore listener error:", error);
                            });
                    } else {
                        console.error("Board not found");
                    }
                })
                .catch(error => {
                    console.error("Error getting board: ", error);
                });
        }
        
        function showBoardSelection() {
            // Unsubscribe from notes listener
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
            }
            
            // Hide board UI and show selection
            corkboardContainer.style.display = 'none';
            boardHeader.style.display = 'none';
            uploadContainer.style.display = 'none';
            boardSelection.style.display = 'flex';
            
            // Reset scroll position
            corkboardContainer.scrollTop = 0;
            
            // Reload boards
            loadBoards();
        }
        
        // Add this function to compress images
        function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed data URL
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function addNoteToBoard(noteData) {
            // Check if note already exists
            if (document.querySelector(`[data-note-id="${noteData.id}"]`)) return;
            
            // Create container for note and pin
            const noteContainer = document.createElement('div');
            noteContainer.className = 'note-container';
            noteContainer.style.left = (noteData.x || 100) + 'px';
            noteContainer.style.top = (noteData.y || 100) + 'px';
            noteContainer.style.width = (noteData.width || 200) + 'px';
            noteContainer.style.height = (noteData.height || 200) + 'px';
            noteContainer.dataset.noteId = noteData.id;
            noteContainer.style.zIndex = noteData.zIndex || highestZIndex++;
            
            // Create pin
            const pin = document.createElement('div');
            pin.className = 'pin';
            noteContainer.appendChild(pin);
            
            // Create note content
            let noteElement;
            
            if (noteData.type === 'image') {
                // Create pinned image element
                noteElement = document.createElement('div');
                noteElement.className = 'pinned-image';
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                
                const imgElement = document.createElement('img');
                imgElement.src = noteData.content;
                imgElement.onerror = function() {
                    console.error("Failed to load image:", noteData.content);
                    this.style.display = 'none';
                };
                noteElement.appendChild(imgElement);
                
            } else {
                // Create sticky note element
                noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                noteElement.setAttribute('data-color', noteData.color || 'yellow');
                
                if (noteData.type === 'text') {
                    const textElement = document.createElement('div');
                    textElement.className = 'note-text';
                    textElement.textContent = noteData.content;
                    noteElement.appendChild(textElement);
                }
            }
            
            noteContainer.appendChild(noteElement);
            
            // Add slight rotation for natural look
            const rotation = noteData.rotation || (Math.random() * 4 - 2);
            noteContainer.style.transform = `rotate(${rotation}deg)`;
            
            if (noteData.userId === currentUser.uid) {
                noteElement.classList.add('mine');
                
                // Add delete button for user's own notes
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('Delete this note?')) {
                        db.collection("notes").doc(noteData.id).delete().catch(error => {
                            console.error("Error deleting note:", error);
                        });
                    }
                });
                noteElement.appendChild(deleteBtn);
            }
            
            // Add resize handle for ALL notes (everyone can resize)
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            noteElement.appendChild(resizeHandle);
            
            // Make resizable
            makeResizable(noteContainer, noteData.id);
            
            // Make draggable
            makeDraggable(noteContainer, noteData.id);
            
            // Bring to front on click
            noteContainer.addEventListener('mousedown', function(e) {
                if (!e.target.classList.contains('delete-btn') && 
                    !e.target.classList.contains('resize-handle')) {
                    bringToFront(noteContainer, noteData.id);
                }
            });
            
            corkboard.appendChild(noteContainer);
        }

        function bringToFront(element, noteId) {
            highestZIndex++;
            element.style.zIndex = highestZIndex;
            
            // Update z-index in database
            db.collection("notes").doc(noteId).update({
                zIndex: highestZIndex
            }).catch(error => {
                console.error("Error updating z-index:", error);
            });
        }

        function updateNoteOnBoard(noteData) {
            const noteContainer = document.querySelector(`[data-note-id="${noteData.id}"]`);
            if (noteContainer) {
                noteContainer.style.left = (noteData.x || 100) + 'px';
                noteContainer.style.top = (noteData.y || 100) + 'px';
                
                if (noteData.width && noteData.height) {
                    noteContainer.style.width = noteData.width + 'px';
                    noteContainer.style.height = noteData.height + 'px';
                }
                
                if (noteData.zIndex) {
                    noteContainer.style.zIndex = noteData.zIndex;
                    if (noteData.zIndex > highestZIndex) {
                        highestZIndex = noteData.zIndex;
                    }
                }
                
                if (noteData.type === 'text') {
                    const textElement = noteContainer.querySelector('.note-text');
                    if (textElement) textElement.textContent = noteData.content;
                }
            }
        }

        function removeNoteFromBoard(noteId) {
            const noteContainer = document.querySelector(`[data-note-id="${noteId}"]`);
            if (noteContainer) noteContainer.remove();
        }

        function makeDraggable(element, noteId) {
            let isDragging = false;
            let startX, startY;
            let startLeft, startTop;
            
            // Make both the pin and note draggable
            const pin = element.querySelector('.pin');
            const note = element.querySelector('.note, .pinned-image');
            
            [pin, note].forEach(draggableElement => {
                draggableElement.addEventListener('mousedown', function(e) {
                    // Don't start drag if clicking on delete button or resize handle
                    if (e.target.classList.contains('delete-btn') || 
                        e.target.classList.contains('resize-handle')) return;
                    
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    // Get current position
                    startLeft = parseInt(element.style.left);
                    startTop = parseInt(element.style.top);
                    
                    element.style.zIndex = highestZIndex++;
                    e.preventDefault();
                });
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                const newX = startLeft + dx;
                const newY = startTop + dy;
                
                // Allow notes to be placed anywhere on the board
                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    
                    // Update position in database
                    db.collection("notes").doc(noteId).update({
                        x: parseInt(element.style.left),
                        y: parseInt(element.style.top),
                        zIndex: parseInt(element.style.zIndex)
                    }).catch(error => {
                        console.error("Error updating note position:", error);
                    });
                }
            });
        }

        function makeResizable(element, noteId) {
            let isResizing = false;
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;
            
            const resizeHandle = element.querySelector('.resize-handle');
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(element.style.width);
                startHeight = parseInt(element.style.height);
                startLeft = parseInt(element.style.left);
                startTop = parseInt(element.style.top);
                
                element.style.zIndex = highestZIndex++;
                e.stopPropagation();
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                // Calculate new dimensions with smaller minimum size constraints
                const newWidth = Math.max(80, startWidth + dx);
                const newHeight = Math.max(80, startHeight + dy);
                
                // Apply new size
                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    
                    // Update size in database
                    db.collection("notes").doc(noteId).update({
                        width: parseInt(element.style.width),
                        height: parseInt(element.style.height),
                        zIndex: parseInt(element.style.zIndex)
                    }).catch(error => {
                        console.error("Error updating note size:", error);
                    });
                }
            });
        }

        // Add text note
        document.getElementById('add-text').addEventListener('click', function() {
            const text = document.getElementById('text-note').value;
            if (text.trim()) {
                const newNote = {
                    id: 'note_' + Date.now(),
                    type: 'text',
                    content: text,
                    x: Math.random() * (corkboardContainer.offsetWidth - 200),
                    y: Math.random() * (corkboardContainer.offsetHeight - 200) + scrollY,
                    width: 200,
                    height: 200,
                    userId: currentUser.uid,
                    boardId: currentBoardId,
                    color: selectedColor,
                    rotation: Math.random() * 4 - 2,
                    zIndex: highestZIndex++,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                db.collection("notes").doc(newNote.id).set(newNote)
                    .then(() => {
                        console.log("Text note added successfully");
                        document.getElementById('text-note').value = '';
                    })
                    .catch(error => {
                        console.error("Error adding text note:", error);
                    });
            }
        });

        // Add image note
        document.getElementById('add-image').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });
        
        document.getElementById('image-upload').addEventListener('change', async function() {
            if (this.files && this.files[0]) {
                try {
                    // Compress the image first
                    const compressedDataUrl = await compressImage(this.files[0]);
                    
                    const newNote = {
                        id: 'note_' + Date.now(),
                        type: 'image',
                        content: compressedDataUrl, // Use compressed image
                         x: Math.random() * (corkboardContainer.offsetWidth - 200),
                        y: Math.random() * (corkboardContainer.offsetHeight - 200) + scrollY,
                        width: 200,
                        height: 200,
                        userId: currentUser.uid,
                        boardId: currentBoardId,
                        rotation: Math.random() * 4 - 2,
                        zIndex: highestZIndex++,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Save to Firebase
                    await db.collection("notes").doc(newNote.id).set(newNote);
                    console.log("Image note added successfully");
                    
                } catch (error) {
                    console.error("Error adding image note:", error);
                }
                this.value = ''; // Reset file input
            }
        });

        // Double-click to edit text notes
        document.addEventListener('dblclick', function(e) {
            if (e.target.classList.contains('note-text')) {
                const textElement = e.target;
                const noteContainer = textElement.closest('.note-container');
                const noteId = noteContainer.dataset.noteId;
                const currentText = textElement.textContent;
                
                if (noteContainer.querySelector('.note').classList.contains('mine')) {
                    const newText = prompt('Edit your note:', currentText);
                    
                    if (newText !== null) {
                        db.collection("notes").doc(noteId).update({
                            content: newText
                        }).catch(error => {
                            console.error("Error updating note text:", error);
                        });
                    }
                }
            }
        });
        
        // Color selection
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                selectedColor = this.getAttribute('data-color');
            });
        });
    </script>
</body>
</html>
